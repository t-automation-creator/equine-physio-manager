import { createClientFromRequest } from 'npm:@base44/sdk@0.8.6';

// Old horse ID -> New Base44 ID mapping
const HORSE_ID_MAP = {
  "horse_1407384540149719635": "696c1461c75e09382bc710f4",
  "horse_1407384744756257364": "696c1461c75e09382bc710f5",
  "horse_1407385900152791640": "696c1461c75e09382bc710f6",
  "horse_1407386521530540635": "696c1461c75e09382bc710f7",
  "horse_1407388049230275168": "696c1461c75e09382bc710f8",
  "horse_1407393146584703599": "696c1461c75e09382bc710f9",
  "horse_1407393939803087472": "696c1461c75e09382bc710fa",
  "horse_1407395803550458483": "696c1461c75e09382bc710fb",
  "horse_1407396237476373110": "696c1461c75e09382bc710fc",
  "horse_1407399848411406970": "696c1461c75e09382bc710fd",
  "horse_1408188412460016048": "696c1461c75e09382bc710fe",
  "horse_1408190016361865649": "696c1461c75e09382bc710ff",
  "horse_1408190779037327794": "696c1461c75e09382bc71100",
  "horse_1408192864411722164": "696c1461c75e09382bc71101",
  "horse_1410753115589714631": "696c1461c75e09382bc71102",
  "horse_1410753508998652616": "696c1461c75e09382bc71103",
  "horse_1411046803071050654": "696c1461c75e09382bc71104",
  "horse_1411047330672550816": "696c1461c75e09382bc71105",
  "horse_1411047734600803234": "696c1461c75e09382bc71106",
  "horse_1411048201611387811": "696c1461c75e09382bc71102",
  "horse_1411703975396253839": "696c1461c75e09382bc71107",
  "horse_1412249778934260057": "696c1461c75e09382bc71108",
  "horse_1413703529893208461": "696c1461c75e09382bc71109",
  "horse_1415093004007383897": "696c1461c75e09382bc7110a",
  "horse_1415094759650763613": "696c1461c75e09382bc7110b",
  "horse_1416866417067696330": "696c1461c75e09382bc7110c",
  "horse_1416868672001024204": "696c1461c75e09382bc7110d",
  "horse_1421560937453724441": "696c1461c75e09382bc7110e",
  "horse_1422312284562138003": "696c1461c75e09382bc7110f",
  "horse_1422345253720957007": "696c1461c75e09382bc71110",
  "horse_1423020079116722380": "696c1461c75e09382bc71111",
  "horse_1423021883137204439": "696c1461c75e09382bc71112",
  "horse_1426039962536517878": "696c1461c75e09382bc71113",
  "horse_1426041799020912899": "696c1461c75e09382bc71114",
  "horse_1427355892197630688": "696c1461c75e09382bc71115",
  "horse_1428078781909705289": "696c1461c75e09382bc71116",
  "horse_1436838049404166900": "696c1461c75e09382bc71117",
  "horse_1436838259362636534": "696c1461c75e09382bc71118",
  "horse_1436838622807466748": "696c1461c75e09382bc71119",
  "horse_1444085702454157959": "696c1461c75e09382bc7111a",
  "horse_1445610884255720398": "696c1461c75e09382bc7111b",
  "horse_1445611093098505167": "696c1461c75e09382bc7111c",
  "horse_1445611245544678352": "696c1461c75e09382bc7111d",
  "horse_1445611506673656787": "696c1461c75e09382bc7111e",
  "horse_1445614229783585766": "696c1461c75e09382bc7111f",
  "horse_1445614481785758696": "696c1461c75e09382bc71120",
  "horse_1455955617058399149": "696c1461c75e09382bc71121",
  "horse_1460679757501834029": "696c1461c75e09382bc71122",
  "horse_1460947248576734132": "696c1461c75e09382bc71123",
  "horse_1463213401181266302": "696c1461c75e09382bc71124",
  "horse_1463236492678668714": "696c1461c75e09382bc71125",
  "horse_1463721664465346927": "696c1461c75e09382bc71126",
  "horse_1467428997842346325": "696c1461c75e09382bc71127",
  "horse_1467441113810870735": "696c1461c75e09382bc71128",
  "horse_1470955089354039390": "696c1461c75e09382bc71129",
  "horse_1473037951511306489": "696c1461c75e09382bc7112a",
  "horse_1475335797870698512": "696c1461c75e09382bc7112b",
  "horse_1476837953438228643": "696c1461c75e09382bc7112c",
  "horse_1482025978610852847": "696c1461c75e09382bc7112d",
  "horse_1486972214740787349": "696c1461c75e09382bc7112e",
  "horse_1488215138346476008": "696c1461c75e09382bc7112f",
  "horse_1488855890097348958": "696c1461c75e09382bc71130",
  "horse_1488950556201329231": "696c1461c75e09382bc71131",
  "horse_1488950693246018129": "696c1461c75e09382bc71132",
  "horse_1490476506390995009": "696c1461c75e09382bc71133",
  "horse_1491918636913270923": "696c1461c75e09382bc71134",
  "horse_1492861625789588190": "696c1461c75e09382bc71135",
  "horse_1492929220580483987": "696c1461c75e09382bc71136",
  "horse_1496326588726256564": "696c1461c75e09382bc71137",
  "horse_1500870009839165871": "696c1461c75e09382bc71138",
  "horse_1509559937603216077": "696c1461c75e09382bc71139",
  "horse_1514261075871146929": "696c1461c75e09382bc7113a",
  "horse_1514552975605899717": "696c1461c75e09382bc7113b",
  "horse_1515301800436048800": "696c1461c75e09382bc7113c",
  "horse_1516525620052369827": "696c1461c75e09382bc7113d",
  "horse_1521916443279499921": "696c1461c75e09382bc7113e",
  "horse_1525623625309234168": "696c1461c75e09382bc7113f",
  "horse_1525623844470006778": "696c1461c75e09382bc71140",
  "horse_1531581350908273295": "696c1461c75e09382bc71141",
  "horse_1533194478523785703": "696c1461c75e09382bc71142",
  "horse_1534155621153120854": "696c1461c75e09382bc71143",
  "horse_1536847998015775692": "696c1461c75e09382bc71144",
  "horse_1547037764514488790": "696c1461c75e09382bc71145",
  "horse_1560215100365742956": "696c1461c75e09382bc71146",
  "horse_1560220037472592764": "696c1461c75e09382bc71147",
  "horse_1561760125738295791": "696c1461c75e09382bc71148",
  "horse_1567245790810743730": "696c1461c75e09382bc71149",
  "horse_1568990131774301114": "696c1461c75e09382bc7114a",
  "horse_1579847363504120214": "696c1461c75e09382bc71147",
  "horse_1581118214966878771": "696c1461c75e09382bc7114b",
  "horse_1596579719141138979": "696c1461c75e09382bc7114c",
  "horse_1598451852779724934": "696c1461c75e09382bc7114d",
  "horse_1607240891418813041": "696c1461c75e09382bc7114c",
  "horse_1632585722634445179": "696c1461c75e09382bc7114e",
  "horse_1660890235938022131": "696c1461c75e09382bc7114f",
  "horse_1662449377383293818": "696c1461c75e09382bc71147",
  "horse_1664484070081438606": "696c1461c75e09382bc71150",
  "horse_1666905071725584666": "696c1461c75e09382bc71151",
  "horse_1679781710239113924": "696c1461c75e09382bc71152",
  "horse_1709552477151437240": "696c1461c75e09382bc71153",
  "horse_1711779147346354381": "696c1461c75e09382bc7113c",
  "horse_1713921718709395898": "696c1461c75e09382bc71154",
  "horse_1715952493919215776": "696c1461c75e09382bc71155",
  "horse_1718217595364057504": "696c1461c75e09382bc71156",
  "horse_1718218030774755747": "696c1461c75e09382bc71113",
  "horse_1730468863151186097": "696c1461c75e09382bc71157",
  "horse_1730484896759030104": "696c1461c75e09382bc71158",
  "horse_1731675462985327036": "696c1461c75e09382bc71147",
  "horse_1731676549972763072": "696c1461c75e09382bc71159",
  "horse_1737648341514199081": "696c1461c75e09382bc7115a",
  "horse_1740400935529619975": "696c1461c75e09382bc7115b",
  "horse_1740665454168383550": "696c1461c75e09382bc7115c",
  "horse_1741223492306609059": "696c1461c75e09382bc7115d",
  "horse_1741490711850656545": "696c1461c75e09382bc7115e",
  "horse_1749347050962559103": "696c1461c75e09382bc7115f",
  "horse_1754916283364679881": "696c1461c75e09382bc71160",
  "horse_1754923604992073973": "696c1461c75e09382bc71161",
  "horse_1756740774759768373": "696c1461c75e09382bc71162",
  "horse_1798010586160701634": "696c1461c75e09382bc71163",
  "horse_1798010812527288515": "696c1461c75e09382bc71164",
  "horse_1798011792652247239": "696c1461c75e09382bc71165",
  "horse_1802292529287143832": "696c1461c75e09382bc71164",
  "horse_1802292682446348697": "696c1461c75e09382bc71166",
  "horse_1802292840823267739": "696c1461c75e09382bc71167",
  "horse_1802297772737569202": "696c1461c75e09382bc71168",
  "horse_1802868594401353924": "696c1461c75e09382bc71147",
  "horse_1810803902149304612": "696c1461c75e09382bc71133",
  "horse_1836309307629510748": "696c1461c75e09382bc71169",
  "horse_1837892218698867488": "696c1461c75e09382bc7116a",
  "horse_1841471425693622807": "696c1461c75e09382bc7112f",
  "horse_1858147898915561661": "696c1461c75e09382bc71147",
  "horse_1865276176822444957": "696c1461c75e09382bc7116b"
};

function flattenNotes(notes) {
  if (!notes || !notes.sections) return '';
  
  let text = '';
  for (const section of notes.sections) {
    if (section.name) text += `${section.name}\n\n`;
    if (section.questions) {
      for (const q of section.questions) {
        if (q.name) text += `${q.name}: `;
        if (q.answer) {
          const cleanAnswer = q.answer.replace(/<[^>]*>/g, '').replace(/\n+/g, ' ').trim();
          text += `${cleanAnswer}\n`;
        } else if (q.answers) {
          const selected = q.answers.filter(a => a.selected).map(a => a.value);
          if (selected.length > 0) text += `${selected.join(', ')}\n`;
        }
      }
    }
    text += '\n';
  }
  return text.trim();
}

Deno.serve(async (req) => {
  try {
    const base44 = createClientFromRequest(req);
    
    const user = await base44.auth.me();
    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { treatments } = await req.json();

    const treatmentsToImport = [];
    let skipped = 0;
    let noHorseMatch = [];

    for (const treatment of treatments) {
      const newHorseId = HORSE_ID_MAP[treatment.horse_id];
      
      if (!newHorseId) {
        noHorseMatch.push(treatment.horse_id);
        skipped++;
        continue;
      }

      const treatmentData = {
        horse_id: newHorseId,
        appointment_id: null,
        notes: flattenNotes(treatment.notes),
        treatment_types: treatment.treatment_types || [],
        photo_urls: [],
        status: treatment.status === 'completed' ? 'completed' : 'not_started',
        follow_up_date: null,
        created_by: 'annievetphysio@gmail.com'
      };

      treatmentsToImport.push(treatmentData);
    }

    const imported = await base44.asServiceRole.entities.Treatment.bulkCreate(treatmentsToImport);

    return Response.json({ 
      success: true, 
      imported: imported.length,
      skipped,
      noHorseMatch: [...new Set(noHorseMatch)]
    });

  } catch (error) {
    return Response.json({ error: error.message, stack: error.stack }, { status: 500 });
  }
});